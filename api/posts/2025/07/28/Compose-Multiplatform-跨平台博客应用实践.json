{"data":{"title":"[Compose Multiplatform]è·¨å¹³å°åšå®¢åº”ç”¨å®è·µ","slug":"Compose-Multiplatform-è·¨å¹³å°åšå®¢åº”ç”¨å®è·µ","description":"","date":"2025-07-28T12:28:00.000Z","updated":"2025-07-28T14:51:23.535Z","language":"zh-CN","comments":true,"url":"2025/07/28/Compose-Multiplatform-è·¨å¹³å°åšå®¢åº”ç”¨å®è·µ/","cover":null,"images":[],"content":"<h2 id=\"ç”¨-CMP-æ„å»ºè·¨å¹³å°åšå®¢åº”ç”¨ï¼šä¸€æ¬¡-Kotlin-çš„å…¨æ ˆå®è·µ\"><a href=\"#ç”¨-CMP-æ„å»ºè·¨å¹³å°åšå®¢åº”ç”¨ï¼šä¸€æ¬¡-Kotlin-çš„å…¨æ ˆå®è·µ\" class=\"headerlink\" title=\"ç”¨ CMP æ„å»ºè·¨å¹³å°åšå®¢åº”ç”¨ï¼šä¸€æ¬¡ Kotlin çš„å…¨æ ˆå®è·µ\"></a>ç”¨ CMP æ„å»ºè·¨å¹³å°åšå®¢åº”ç”¨ï¼šä¸€æ¬¡ Kotlin çš„å…¨æ ˆå®è·µ</h2><p>åœ¨è¿½æ±‚é«˜æ•ˆå¼€å‘çš„æ—¶ä»£ï¼Œè·¨å¹³å°æŠ€æœ¯å·²æˆä¸ºç§»åŠ¨åº”ç”¨å¼€å‘çš„ä¸»æµé€‰æ‹©ï¼Œæ­¤å‰åŸºäºé¸¿è’™çš„å¼€å‘å¹³å°å¼€å‘ <a href=\"https://julis.wang/2025/05/16/%E9%B8%BF%E8%92%99-%E5%86%99%E4%BA%86%E4%B8%AA%E5%9F%BA%E4%BA%8EHexo%E5%8D%9A%E5%AE%A2%E7%9A%84%E9%B8%BF%E8%92%99App/\">blog_harmony</a>ï¼Œå°†è‡ªå·±åšå®¢æ–‡ç« è¿›è¡Œå±•ç¤ºã€‚æœ¬æ–‡å°†ä»‹ç»åŸºäº <strong>CMP(Compose Multiplatform)</strong> æ„å»ºçš„å¼€æºåšå®¢åº”ç”¨ <a href=\"https://github.com/VomPom/blog_kmp\">blog_kmp</a>ï¼Œå±•ç¤ºå¦‚ä½•ç”¨ Kotlin å®ç°è·¨å¹³å°çš„åº”ç”¨å¼€å‘ã€‚</p>\n<h3 id=\"Compose-Multiplatform\"><a href=\"#Compose-Multiplatform\" class=\"headerlink\" title=\"Compose Multiplatform\"></a>Compose Multiplatform</h3><p>Compose Multiplatform æ˜¯ JetBrains æ¨å‡ºçš„å£°æ˜å¼ UI æ¡†æ¶ï¼ŒåŸºäº Jetpack Compose æ‰©å±•è€Œæ¥ï¼š</p>\n<ul>\n<li><strong>æ ¸å¿ƒä¼˜åŠ¿</strong>ï¼šç”¨åŒä¸€å¥— Kotlin ä»£ç æ„å»º Androidã€iOSã€Desktop å’Œ Web åº”ç”¨</li>\n<li><strong>å¼€å‘æ•ˆç‡</strong>ï¼šå®æ—¶é¢„è§ˆã€çƒ­é‡è½½åŠ é€Ÿå¼€å‘è¿­ä»£</li>\n<li><strong>åŸç”Ÿæ€§èƒ½</strong>ï¼šé€šè¿‡ Skia æ¸²æŸ“å¼•æ“å®ç°æ¥è¿‘åŸç”Ÿä½“éªŒ</li>\n<li><strong>å…±äº«é€»è¾‘</strong>ï¼šä¸šåŠ¡é€»è¾‘ã€ç½‘ç»œè¯·æ±‚ã€çŠ¶æ€ç®¡ç†å¯ 100% å¤ç”¨</li>\n</ul>\n<h3 id=\"é¡¹ç›®æ¶æ„ä¸æŠ€æœ¯æ ˆ\"><a href=\"#é¡¹ç›®æ¶æ„ä¸æŠ€æœ¯æ ˆ\" class=\"headerlink\" title=\"é¡¹ç›®æ¶æ„ä¸æŠ€æœ¯æ ˆ\"></a>é¡¹ç›®æ¶æ„ä¸æŠ€æœ¯æ ˆ</h3><p>blog_kmp é‡‡ç”¨åˆ†å±‚æ¶æ„è®¾è®¡ï¼Œæ ¸å¿ƒæ¨¡å—åŒ…æ‹¬ï¼š</p>\n<figure class=\"highlight kotlin\"><table><tr><td class=\"code\"><pre><span class=\"line\">shared/</span><br><span class=\"line\">â”œâ”€â”€ src/commonMain/kotlin/  # å…±äº«ä¸šåŠ¡é€»è¾‘</span><br><span class=\"line\">â”‚   â”œâ”€â”€ <span class=\"keyword\">data</span>/               # æ•°æ®å±‚</span><br><span class=\"line\">â”‚   â”œâ”€â”€ domain/             # é¢†åŸŸæ¨¡å‹</span><br><span class=\"line\">â”‚   â””â”€â”€ presentation/       # UIçŠ¶æ€ç®¡ç†</span><br><span class=\"line\">â”œâ”€â”€ src/androidMain/        # Android å¹³å°ä»£ç </span><br><span class=\"line\">â””â”€â”€ src/iosMain/            # iOS å¹³å°é€‚é…</span><br><span class=\"line\">â”œâ”€â”€ composeApp</span><br><span class=\"line\">â”‚Â Â  â”œâ”€â”€ build.gradle.kts</span><br><span class=\"line\">â”‚Â Â  â””â”€â”€ src</span><br><span class=\"line\">â”‚Â Â      â”œâ”€â”€ androidMain     # Android å¹³å°ä»£ç </span><br><span class=\"line\">â”‚Â Â      â”œâ”€â”€ commonMain      # å…±äº«ä¸šåŠ¡é€»è¾‘</span><br><span class=\"line\">â”‚            â”œâ”€â”€ App.kt     # ç•Œé¢å±•ç¤ºå…¥å£</span><br><span class=\"line\">â”‚            â”œâ”€â”€ <span class=\"keyword\">data</span>       # æ•°æ®å±‚</span><br><span class=\"line\">â”‚            â”‚   â”œâ”€â”€ api        # ç½‘ç»œè¯·æ±‚</span><br><span class=\"line\">â”‚            â”‚   â”œâ”€â”€ di         # koin ä¾èµ–æ³¨å…¥</span><br><span class=\"line\">â”‚            â”‚   â”œâ”€â”€ model      # model æ•°æ®</span><br><span class=\"line\">â”‚            â”‚   â””â”€â”€ repository # æ•°æ®ç¼“å­˜ç®¡ç†</span><br><span class=\"line\">â”‚            â”‚</span><br><span class=\"line\">â”‚            â”œâ”€â”€ navigation  # é¡µé¢é—´å¯¼èˆªç®¡ç†</span><br><span class=\"line\">â”‚            â”œâ”€â”€ platform    # é€šè¿‡å¯¹å„ä¸ªå¹³å°æŠ½è±¡çš„æ¥å£ </span><br><span class=\"line\">â”‚            â””â”€â”€ ui          # é€šç”¨ UI é€»è¾‘</span><br><span class=\"line\">â”‚</span><br><span class=\"line\">â”‚Â Â      â”œâ”€â”€ desktopMain     # Desktop å¹³å°é€‚é…</span><br><span class=\"line\">â”‚Â Â      â””â”€â”€ iosMain         # iOS å¹³å°é€‚é…</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"åŠŸèƒ½é¢„è§ˆ\"><a href=\"#åŠŸèƒ½é¢„è§ˆ\" class=\"headerlink\" title=\"åŠŸèƒ½é¢„è§ˆ\"></a>åŠŸèƒ½é¢„è§ˆ</h2><h3 id=\"Android\"><a href=\"#Android\" class=\"headerlink\" title=\"Android\"></a>Android</h3><p><img src=\"https://cdn.julis.wang/github/blog_cmp/android.png\"></p>\n<h4 id=\"æ·±è‰²æ¨¡å¼\"><a href=\"#æ·±è‰²æ¨¡å¼\" class=\"headerlink\" title=\"æ·±è‰²æ¨¡å¼\"></a>æ·±è‰²æ¨¡å¼</h4><p><img src=\"https://cdn.julis.wang/github/blog_cmp/dark.png\"></p>\n<h3 id=\"iOS\"><a href=\"#iOS\" class=\"headerlink\" title=\"iOS\"></a>iOS</h3><p><img src=\"https://cdn.julis.wang/github/blog_cmp/ios.png\"></p>\n<h3 id=\"Desktop\"><a href=\"#Desktop\" class=\"headerlink\" title=\"Desktop\"></a>Desktop</h3><p><img src=\"https://cdn.julis.wang/github/blog_cmp/desktop.png\"></p>\n<h4 id=\"ä¸»è¦æŠ€æœ¯æ ˆ\"><a href=\"#ä¸»è¦æŠ€æœ¯æ ˆ\" class=\"headerlink\" title=\"ä¸»è¦æŠ€æœ¯æ ˆ\"></a>ä¸»è¦æŠ€æœ¯æ ˆ</h4><ol>\n<li><strong>Ktor å®¢æˆ·ç«¯</strong> - ç½‘ç»œè¯·æ±‚</li>\n</ol>\n<figure class=\"highlight kotlin\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">val</span> httpClient = HttpClient &#123;</span><br><span class=\"line\">    install(ContentNegotiation) &#123;</span><br><span class=\"line\">        json(Json &#123; ignoreUnknownKeys = <span class=\"literal\">true</span> &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">suspend</span> <span class=\"function\"><span class=\"keyword\">fun</span> <span class=\"title\">loadPosts</span><span class=\"params\">()</span></span>: List&lt;Post&gt; = </span><br><span class=\"line\">    httpClient.<span class=\"keyword\">get</span>(<span class=\"string\">&quot;https://cdn.julis/api/posts&quot;</span>).body()</span><br></pre></td></tr></table></figure>\n\n<ol start=\"2\">\n<li><strong>DataStore</strong> - è·¨å¹³å°æ•°æ®åº“</li>\n</ol>\n<figure class=\"highlight kotlin\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">val</span> dataKey = stringPreferencesKey(key)</span><br><span class=\"line\"><span class=\"keyword\">val</span> result = dataStore.<span class=\"keyword\">data</span></span><br><span class=\"line\">    .<span class=\"keyword\">catch</span> &#123; exception -&gt;</span><br><span class=\"line\">        <span class=\"comment\">// dataStore.data throws an IOException when an error is encountered when reading data</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (exception <span class=\"keyword\">is</span> IOException) &#123;</span><br><span class=\"line\">            emit(emptyPreferences())</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> exception</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    .map &#123; preferences -&gt;</span><br><span class=\"line\">        <span class=\"keyword\">val</span> <span class=\"keyword\">data</span>: String? = preferences[dataKey]</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">data</span> == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"literal\">null</span></span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (isJson) Json.decodeFromString&lt;T&gt;(<span class=\"keyword\">data</span>) <span class=\"keyword\">else</span> (<span class=\"keyword\">data</span> <span class=\"keyword\">as</span> T)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<ol start=\"3\">\n<li><strong>Koin</strong> - ä¾èµ–æ³¨å…¥</li>\n</ol>\n<figure class=\"highlight kotlin\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">val</span> sharedModule = module &#123;</span><br><span class=\"line\">    single&lt;PostRepository&gt; &#123; PostRepositoryImpl(<span class=\"keyword\">get</span>()) &#125;</span><br><span class=\"line\">    viewModel &#123; PostViewModel(<span class=\"keyword\">get</span>()) &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<ol start=\"4\">\n<li><strong>Kotlinx.Serialization</strong> - JSON è§£æ</li>\n</ol>\n<figure class=\"highlight kotlin\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Serializable</span></span><br><span class=\"line\"><span class=\"keyword\">data</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Post</span>(</span><br><span class=\"line\">    <span class=\"keyword\">val</span> id: String,</span><br><span class=\"line\">    <span class=\"keyword\">val</span> title: String,</span><br><span class=\"line\">    <span class=\"keyword\">val</span> content: String</span><br><span class=\"line\">)</span><br></pre></td></tr></table></figure>\n\n<ol start=\"5\">\n<li><strong>compose-webview-multiplatform</strong> - WebView æµè§ˆå™¨<br>ä½¿ç”¨çš„ç¬¬ä¸‰æ–¹å¼€å‘<a href=\"https://github.com/KevinnZou/compose-webview-multiplatform\">compose-webview-multiplatform</a>åŸºäº <a href=\"https://github.com/chromiumembedded/java-cef\">java-cef</a>å¼€å‘ï¼Œä¸è¿‡è¿™ä¸ªlibrary åœ¨ desktop å¹³å°è¡¨ç°ä¸æ˜¯å¤ªå¥½ï¼Œå¾…å®Œå–„ã€‚</li>\n</ol>\n<figure class=\"highlight kotlin\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">val</span> state = rememberWebViewState(postUrl)</span><br><span class=\"line\"> WebView(state = state,modifier = Modifier.fillMaxSize())            </span><br></pre></td></tr></table></figure>\n\n\n<h3 id=\"å¹³å°ç‰¹å®šå®ç°\"><a href=\"#å¹³å°ç‰¹å®šå®ç°\" class=\"headerlink\" title=\"å¹³å°ç‰¹å®šå®ç°\"></a>å¹³å°ç‰¹å®šå®ç°</h3><p>UI å±‚é¢ä¸‰ç«¯èƒ½å¤Ÿä½¿ç”¨åŒä¸€ä»½ä»£ç ï¼Œä½†ä¸ºäº†ä½“éªŒï¼Œå¯èƒ½éœ€è¦é’ˆå¯¹ä¸åŒçš„è®¾è®¡ï¼Œåœ¨æ¡Œé¢ç«¯å¯ä»¥è®¾è®¡æ›´å¥½åœ°ä½“éªŒUIã€‚è¿™é‡Œé¿å…ä¸äº† if-else çš„UIé€»è¾‘ï¼Œä»¥åŠä¸€äº›ä¾èµ–å„ç§ç³»ç»Ÿçš„ api éœ€è¦å•ç‹¬å®ç°ï¼Œæ¯”å¦‚ï¼šæ·±è‰²æ¨¡å¼ç›‘å¬ã€èµ„æºå­˜å‚¨è·¯å¾„ã€ç³»ç»Ÿä¿¡æ¯ã€çŠ¶æ€æ é¢œè‰²ç­‰ã€‚</p>\n<p><strong>Android ç«¯</strong><br>Android ç‰¹å®šçš„åŠŸèƒ½ç»“åˆä½¿ç”¨èµ·æ¥éå¸¸çš„ç®€å•ï¼Œæ¯•ç«Ÿéƒ½æ˜¯æœ‰è¡€ç¼˜å…³ç³»çš„ã€‚å¯ä»¥ä½¿ç”¨ AndroidView ç›´æ¥æ¸²æŸ“åŸç”Ÿçš„ UI é¡µé¢ã€‚</p>\n<figure class=\"highlight kotlin\"><table><tr><td class=\"code\"><pre><span class=\"line\">AndroidView(</span><br><span class=\"line\">      modifier = Modifier.fillMaxSize(),</span><br><span class=\"line\">      factory = &#123; context -&gt;</span><br><span class=\"line\">          MyView(context) &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      update = &#123; view -&gt;&#125;</span><br><span class=\"line\">  )</span><br></pre></td></tr></table></figure>\n\n<p><strong>iOS ç«¯</strong><br>iOSç«¯ä¸»è¦éœ€è¦ XCode è¿›è¡Œé…åˆï¼Œè¿˜éœ€è¦å…³æ³¨å¼€å‘è€…è´¦å·ç›¸å…³çš„ä¿¡æ¯ç­‰ï¼Œå…¶ä»–ä¸ Android ç«¯å®ç°æ²¡æœ‰å¤ªå¤§çš„å·®å¼‚ã€‚</p>\n<p><strong>æ¡Œé¢ç«¯</strong><br>åˆ©ç”¨ Compose Desktop çš„çª—å£ç®¡ç†ï¼Œå¯ä»¥å®ç°çª—å£å¤šå¼€ã€‚</p>\n<figure class=\"highlight kotlin\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">fun</span> <span class=\"title\">main</span><span class=\"params\">()</span></span> = application &#123;</span><br><span class=\"line\">    Window(onCloseRequest = ::exitApplication) &#123;</span><br><span class=\"line\">        DesktopAppTheme &#123; AppContent() &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n<h3 id=\"ğŸš€-æ€§èƒ½ä¼˜åŒ–å®è·µ\"><a href=\"#ğŸš€-æ€§èƒ½ä¼˜åŒ–å®è·µ\" class=\"headerlink\" title=\"ğŸš€ æ€§èƒ½ä¼˜åŒ–å®è·µ\"></a>ğŸš€ æ€§èƒ½ä¼˜åŒ–å®è·µ</h3><ol>\n<li><strong>åˆ†é¡µåŠ è½½</strong>ï¼šå®ç°æ‡’åŠ è½½é˜²æ­¢é•¿åˆ—è¡¨å¡é¡¿</li>\n</ol>\n<figure class=\"highlight kotlin\"><table><tr><td class=\"code\"><pre><span class=\"line\">LazyColumn &#123;</span><br><span class=\"line\">    itemsIndexed(posts) &#123; _, post -&gt;</span><br><span class=\"line\">        PostItem(post)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    item &#123; <span class=\"keyword\">if</span> (loading) LoadingIndicator() &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<ol start=\"2\">\n<li><strong>æœ¬åœ°ç¼“å­˜</strong>ï¼šDataStore ç¦»çº¿å­˜å‚¨ + Ktor ç¼“å­˜ç­–ç•¥</li>\n</ol>\n<figure class=\"highlight kotlin\"><table><tr><td class=\"code\"><pre><span class=\"line\">HttpClient &#123;</span><br><span class=\"line\">    install(HttpCache) <span class=\"comment\">// å¯ç”¨ HTTP ç¼“å­˜</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<ol start=\"3\">\n<li><strong>å›¾åƒå¤„ç†</strong>ï¼šæ­é… Coil å®ç°é«˜æ•ˆå›¾ç‰‡åŠ è½½</li>\n</ol>\n<figure class=\"highlight kotlin\"><table><tr><td class=\"code\"><pre><span class=\"line\">AsyncImage(</span><br><span class=\"line\">    modifier = Modifier.size(<span class=\"number\">80.</span>dp)</span><br><span class=\"line\">        .shadow(</span><br><span class=\"line\">            elevation = <span class=\"number\">5.</span>dp,</span><br><span class=\"line\">            shape = CircleShape,</span><br><span class=\"line\">            spotColor = Color.Black</span><br><span class=\"line\">        )</span><br><span class=\"line\">        .clip(CircleShape)</span><br><span class=\"line\">        .clickable &#123; &#125;,</span><br><span class=\"line\">    model = AppConfig.AVATAR,</span><br><span class=\"line\">    contentDescription = AppConfig.AVATAR,</span><br><span class=\"line\">)</span><br></pre></td></tr></table></figure>\n<h3 id=\"å¼€å‘ç»éªŒæ€»ç»“\"><a href=\"#å¼€å‘ç»éªŒæ€»ç»“\" class=\"headerlink\" title=\"å¼€å‘ç»éªŒæ€»ç»“\"></a>å¼€å‘ç»éªŒæ€»ç»“</h3><ol>\n<li><p><strong>UIç•Œé¢</strong><br>  ä½¿ç”¨ <a href=\"https://developer.android.com/compose\">Compose</a> è¿›è¡Œç•Œé¢å¸ƒå±€å¼€å‘ï¼Œå£°æ˜æ€§ç¼–ç¨‹èŒƒå¼ç›¸æ¯”äºä¼ ç»Ÿçš„ xml å¸ƒå±€å¼€å‘ï¼Œé«˜æ•ˆå¾ˆå¤šï¼Œä½¿ç”¨ä¹Ÿå¾ˆæ–¹ä¾¿ã€‚ä½¿ç”¨äº†è¿™ç§æ–¹å¼ï¼Œä¼ ç»Ÿçš„ UI å¼€å‘æ–¹å¼å†ä¹Ÿå›ä¸å»äº†ã€‚</p>\n</li>\n<li><p><strong>çŠ¶æ€ç®¡ç†</strong><br>ä½¿ç”¨ <code>mutableStateOf</code> å®ç°å“åº”å¼æ›´æ–°ï¼Œæˆ–è€…ä½¿ç”¨ <code>derivedStateOf</code> å®ç°æ´¾ç”ŸçŠ¶æ€çš„å¤„ç†ã€‚</p>\n</li>\n</ol>\n<figure class=\"highlight kotlin\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> pagIndex <span class=\"keyword\">by</span> remember &#123; mutableStateOf(<span class=\"number\">0</span>) &#125;</span><br><span class=\"line\"><span class=\"keyword\">var</span> errorState <span class=\"keyword\">by</span> remember &#123; mutableStateOf&lt;String?&gt;(<span class=\"literal\">null</span>) &#125;   </span><br><span class=\"line\"><span class=\"keyword\">val</span> themeState <span class=\"keyword\">by</span> mineViewModel.appTheme.collectAsState()</span><br><span class=\"line\"><span class=\"keyword\">val</span> uiChecked <span class=\"keyword\">by</span> remember(themeState) &#123; derivedStateOf &#123; themeState == ThemeConstants.DARK &#125; &#125;</span><br></pre></td></tr></table></figure>\n\n\n<ol start=\"3\">\n<li><strong>å¯¼èˆª</strong></li>\n</ol>\n<p>å®ç° <code>Compose Navigator</code> ç»Ÿä¸€è·¯ç”±ç®¡ç†</p>\n<figure class=\"highlight kotlin\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">val</span> gotoDebug: () -&gt; <span class=\"built_in\">Unit</span> = &#123;</span><br><span class=\"line\">    navController.navigate(Routes.Debug())</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">val</span> goToPostDetail: (Post) -&gt; <span class=\"built_in\">Unit</span> = &#123; it -&gt;</span><br><span class=\"line\">    navController.navigate(Routes.PostDetail(title = it.title, it.url))</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<ol start=\"4\">\n<li><strong>Kotlin Flow</strong><br>ç®€åŒ–å¼‚æ­¥ç¼–ç¨‹ï¼Œè®©ç½‘ç»œè¯·æ±‚çš„ä»£ç çœ‹èµ·æ¥æ›´ç›´è§‚</li>\n</ol>\n<figure class=\"highlight kotlin\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">fun</span> <span class=\"title\">loadAllPost</span><span class=\"params\">()</span></span>: Flow&lt;List&lt;PostV2&gt;&gt; = load(<span class=\"string\">&quot;allPosts&quot;</span>) &#123;</span><br><span class=\"line\">    postApi.getAllPost()?.<span class=\"keyword\">data</span> ?: emptyList()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">suspend</span> <span class=\"function\"><span class=\"keyword\">fun</span> <span class=\"title\">getAllPost</span><span class=\"params\">()</span></span>: SearchResponse? = request&lt;SearchResponse&gt;(getUrl(<span class=\"string\">&quot;api/search.json&quot;</span>))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">suspend</span> <span class=\"keyword\">inline</span> <span class=\"function\"><span class=\"keyword\">fun</span> <span class=\"type\">&lt;<span class=\"keyword\">reified</span> T&gt;</span> <span class=\"title\">request</span><span class=\"params\">(url: <span class=\"type\">String</span>)</span></span>: T? &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        client.<span class=\"keyword\">get</span>(url).body()</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (e: Exception) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (e <span class=\"keyword\">is</span> CancellationException) <span class=\"keyword\">throw</span> e</span><br><span class=\"line\">        e.printStackTrace()</span><br><span class=\"line\">        <span class=\"literal\">null</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"æ€»ç»“\"><a href=\"#æ€»ç»“\" class=\"headerlink\" title=\"æ€»ç»“\"></a>æ€»ç»“</h3><p>ç»è¿‡ä¸€ç•ªå„ç§æŠ˜è…¾ï¼Œå°†å¾ˆå¤šåœ¨å·¥ä½œä¸Šæ— æ³•ä½¿ç”¨çš„èƒ½åŠ›ï¼ˆKoinã€Flowã€DataStoreâ€¦â€¦ï¼‰éƒ½ä½“éªŒä½¿ç”¨äº†ä¸€ä¸‹ï¼Œåœ¨ä¸šä½™çš„æ—¶é—´å®Œæˆäº†åŸºäºåšå®¢æ–‡ç« æ„å»ºçš„ App åœ¨ä¸‰ä¸ªå¹³å°ä¸Šçš„å¼€å‘ï¼Œå®é™…ä¸Šæœ€åˆæˆ‘ä¹Ÿæƒ³æ­å»º WebJs çš„å¹³å°çš„ï¼Œåé¢åˆ é™¤æ‰äº†ï¼Œå› ä¸ºæ¶‰åŠåˆ° web å¹³å°å¼€å‘çš„å„ç§åº“ç›¸æ¯”å®¢æˆ·ç«¯å°‘å¾ˆå¤šï¼Œå…¼å®¹èµ·æ¥ä¹Ÿæ¯”è¾ƒè´¹åŠ²ã€‚KMP&#x2F;CMP è¿™å—æŠ€æœ¯ç¡®å®æ˜¯èƒ½å¾ˆå¤§åœ°èŠ‚çœå¼€å‘äººåŠ›ï¼Œå¤šç«¯ä½¿ç”¨åŒä¸€ä»½UIé€»è¾‘ä»£ç ï¼Œéƒ¨åˆ†é€»è¾‘ä¹Ÿå¯ä»¥ç”¨ kotlin ç»Ÿä¸€è¿›è¡Œå°è£…ï¼Œåç»­ç»´æŠ¤ä¹Ÿä¼šæ–¹ä¾¿å¾ˆå¤šã€‚ä½†è¿™é‡Œæœ‰ä¸ªç¼ºç‚¹å°±æ˜¯æ¶‰åŠåˆ°çš„åº“æ‰€éœ€è¦çš„ kotlin&#x2F;Java ç‰ˆæœ¬è¦æ±‚æ¯”è¾ƒé«˜ï¼Œé™¤éå¼€å‘ä¸€äº›ç‹¬ç«‹çš„ Appï¼Œå¦åˆ™å…¬å¸é‡Œçš„é¡¹ç›®æƒ³åŸºäºè¿™äº›æŠ€æœ¯å»å®ç°ä¸å¤ªå¤§å¯èƒ½ã€‚ä»¥åŠå¦‚æœæ‰€éœ€è¦çš„èƒ½åŠ›æ¯”è¾ƒä¾èµ–ä¸åŸç”Ÿï¼Œæ¯”å¦‚éŸ³è§†é¢‘é¢†åŸŸå°±æœ‰ä¸€å®šçš„å±€é™æ€§ï¼Œæ€»ä½“æ¥è®²æ›´é€‚åˆåäº¤äº’ä¸šåŠ¡çš„å¼€å‘ã€‚</p>\n<p><strong>é¡¹ç›®æºç </strong>: <a href=\"https://github.com/VomPom/blog_kmp\">https://github.com/VomPom/blog_kmp</a>  </p>\n","raw":"\ntitle: '[Compose Multiplatform]è·¨å¹³å°åšå®¢åº”ç”¨å®è·µ'\nauthor: è½å¶æŒ½æ­Œ\ntags:\n  - KMP\ncategories:\n  - æ€è€ƒæ€»ç»“\ndate: 2025-07-28 20:28:00\n---\n\n\n## ç”¨ CMP æ„å»ºè·¨å¹³å°åšå®¢åº”ç”¨ï¼šä¸€æ¬¡ Kotlin çš„å…¨æ ˆå®è·µ\n\nåœ¨è¿½æ±‚é«˜æ•ˆå¼€å‘çš„æ—¶ä»£ï¼Œè·¨å¹³å°æŠ€æœ¯å·²æˆä¸ºç§»åŠ¨åº”ç”¨å¼€å‘çš„ä¸»æµé€‰æ‹©ï¼Œæ­¤å‰åŸºäºé¸¿è’™çš„å¼€å‘å¹³å°å¼€å‘ [blog_harmony](https://julis.wang/2025/05/16/%E9%B8%BF%E8%92%99-%E5%86%99%E4%BA%86%E4%B8%AA%E5%9F%BA%E4%BA%8EHexo%E5%8D%9A%E5%AE%A2%E7%9A%84%E9%B8%BF%E8%92%99App/)ï¼Œå°†è‡ªå·±åšå®¢æ–‡ç« è¿›è¡Œå±•ç¤ºã€‚æœ¬æ–‡å°†ä»‹ç»åŸºäº **CMP(Compose Multiplatform)** æ„å»ºçš„å¼€æºåšå®¢åº”ç”¨ [blog_kmp](https://github.com/VomPom/blog_kmp)ï¼Œå±•ç¤ºå¦‚ä½•ç”¨ Kotlin å®ç°è·¨å¹³å°çš„åº”ç”¨å¼€å‘ã€‚\n\n### Compose Multiplatform \nCompose Multiplatform æ˜¯ JetBrains æ¨å‡ºçš„å£°æ˜å¼ UI æ¡†æ¶ï¼ŒåŸºäº Jetpack Compose æ‰©å±•è€Œæ¥ï¼š\n- **æ ¸å¿ƒä¼˜åŠ¿**ï¼šç”¨åŒä¸€å¥— Kotlin ä»£ç æ„å»º Androidã€iOSã€Desktop å’Œ Web åº”ç”¨\n- **å¼€å‘æ•ˆç‡**ï¼šå®æ—¶é¢„è§ˆã€çƒ­é‡è½½åŠ é€Ÿå¼€å‘è¿­ä»£\n- **åŸç”Ÿæ€§èƒ½**ï¼šé€šè¿‡ Skia æ¸²æŸ“å¼•æ“å®ç°æ¥è¿‘åŸç”Ÿä½“éªŒ\n- **å…±äº«é€»è¾‘**ï¼šä¸šåŠ¡é€»è¾‘ã€ç½‘ç»œè¯·æ±‚ã€çŠ¶æ€ç®¡ç†å¯ 100% å¤ç”¨\n\n### é¡¹ç›®æ¶æ„ä¸æŠ€æœ¯æ ˆ\nblog_kmp é‡‡ç”¨åˆ†å±‚æ¶æ„è®¾è®¡ï¼Œæ ¸å¿ƒæ¨¡å—åŒ…æ‹¬ï¼š\n\n```kotlin\nshared/\nâ”œâ”€â”€ src/commonMain/kotlin/  # å…±äº«ä¸šåŠ¡é€»è¾‘\nâ”‚   â”œâ”€â”€ data/               # æ•°æ®å±‚\nâ”‚   â”œâ”€â”€ domain/             # é¢†åŸŸæ¨¡å‹\nâ”‚   â””â”€â”€ presentation/       # UIçŠ¶æ€ç®¡ç†\nâ”œâ”€â”€ src/androidMain/        # Android å¹³å°ä»£ç \nâ””â”€â”€ src/iosMain/            # iOS å¹³å°é€‚é…\nâ”œâ”€â”€ composeApp\nâ”‚Â Â  â”œâ”€â”€ build.gradle.kts\nâ”‚Â Â  â””â”€â”€ src\nâ”‚Â Â      â”œâ”€â”€ androidMain     # Android å¹³å°ä»£ç \nâ”‚Â Â      â”œâ”€â”€ commonMain      # å…±äº«ä¸šåŠ¡é€»è¾‘\nâ”‚            â”œâ”€â”€ App.kt     # ç•Œé¢å±•ç¤ºå…¥å£\nâ”‚            â”œâ”€â”€ data       # æ•°æ®å±‚\nâ”‚            â”‚   â”œâ”€â”€ api        # ç½‘ç»œè¯·æ±‚\nâ”‚            â”‚   â”œâ”€â”€ di         # koin ä¾èµ–æ³¨å…¥\nâ”‚            â”‚   â”œâ”€â”€ model      # model æ•°æ®\nâ”‚            â”‚   â””â”€â”€ repository # æ•°æ®ç¼“å­˜ç®¡ç†\nâ”‚            â”‚\nâ”‚            â”œâ”€â”€ navigation  # é¡µé¢é—´å¯¼èˆªç®¡ç†\nâ”‚            â”œâ”€â”€ platform    # é€šè¿‡å¯¹å„ä¸ªå¹³å°æŠ½è±¡çš„æ¥å£ \nâ”‚            â””â”€â”€ ui          # é€šç”¨ UI é€»è¾‘\nâ”‚\nâ”‚Â Â      â”œâ”€â”€ desktopMain     # Desktop å¹³å°é€‚é…\nâ”‚Â Â      â””â”€â”€ iosMain         # iOS å¹³å°é€‚é…\n```\n\n## åŠŸèƒ½é¢„è§ˆ\n\n### Android\n![](https://cdn.julis.wang/github/blog_cmp/android.png)\n\n#### æ·±è‰²æ¨¡å¼\n![](https://cdn.julis.wang/github/blog_cmp/dark.png)\n\n### iOS\n\n![](https://cdn.julis.wang/github/blog_cmp/ios.png)\n### Desktop\n\n![](https://cdn.julis.wang/github/blog_cmp/desktop.png)\n\n#### ä¸»è¦æŠ€æœ¯æ ˆ\n1. **Ktor å®¢æˆ·ç«¯** - ç½‘ç»œè¯·æ±‚\n```kotlin\nval httpClient = HttpClient {\n    install(ContentNegotiation) {\n        json(Json { ignoreUnknownKeys = true })\n    }\n}\nsuspend fun loadPosts(): List<Post> = \n    httpClient.get(\"https://cdn.julis/api/posts\").body()\n```\n\n2. **DataStore** - è·¨å¹³å°æ•°æ®åº“\n```kotlin\nval dataKey = stringPreferencesKey(key)\nval result = dataStore.data\n    .catch { exception ->\n        // dataStore.data throws an IOException when an error is encountered when reading data\n        if (exception is IOException) {\n            emit(emptyPreferences())\n        } else {\n            throw exception\n        }\n    }\n    .map { preferences ->\n        val data: String? = preferences[dataKey]\n        if (data == null) {\n            null\n        } else {\n            if (isJson) Json.decodeFromString<T>(data) else (data as T)\n        }\n    }\n```\n\n3. **Koin** - ä¾èµ–æ³¨å…¥\n```kotlin\nval sharedModule = module {\n    single<PostRepository> { PostRepositoryImpl(get()) }\n    viewModel { PostViewModel(get()) }\n}\n```\n\n4. **Kotlinx.Serialization** - JSON è§£æ\n```kotlin\n@Serializable\ndata class Post(\n    val id: String,\n    val title: String,\n    val content: String\n)\n```\n\n5. **compose-webview-multiplatform** - WebView æµè§ˆå™¨\nä½¿ç”¨çš„ç¬¬ä¸‰æ–¹å¼€å‘[compose-webview-multiplatform](https://github.com/KevinnZou/compose-webview-multiplatform)åŸºäº [java-cef](https://github.com/chromiumembedded/java-cef)å¼€å‘ï¼Œä¸è¿‡è¿™ä¸ªlibrary åœ¨ desktop å¹³å°è¡¨ç°ä¸æ˜¯å¤ªå¥½ï¼Œå¾…å®Œå–„ã€‚\n```kotlin\nval state = rememberWebViewState(postUrl)\n WebView(state = state,modifier = Modifier.fillMaxSize())            \n```\n\n\n### å¹³å°ç‰¹å®šå®ç°\nUI å±‚é¢ä¸‰ç«¯èƒ½å¤Ÿä½¿ç”¨åŒä¸€ä»½ä»£ç ï¼Œä½†ä¸ºäº†ä½“éªŒï¼Œå¯èƒ½éœ€è¦é’ˆå¯¹ä¸åŒçš„è®¾è®¡ï¼Œåœ¨æ¡Œé¢ç«¯å¯ä»¥è®¾è®¡æ›´å¥½åœ°ä½“éªŒUIã€‚è¿™é‡Œé¿å…ä¸äº† if-else çš„UIé€»è¾‘ï¼Œä»¥åŠä¸€äº›ä¾èµ–å„ç§ç³»ç»Ÿçš„ api éœ€è¦å•ç‹¬å®ç°ï¼Œæ¯”å¦‚ï¼šæ·±è‰²æ¨¡å¼ç›‘å¬ã€èµ„æºå­˜å‚¨è·¯å¾„ã€ç³»ç»Ÿä¿¡æ¯ã€çŠ¶æ€æ é¢œè‰²ç­‰ã€‚\n\n**Android ç«¯**  \nAndroid ç‰¹å®šçš„åŠŸèƒ½ç»“åˆä½¿ç”¨èµ·æ¥éå¸¸çš„ç®€å•ï¼Œæ¯•ç«Ÿéƒ½æ˜¯æœ‰è¡€ç¼˜å…³ç³»çš„ã€‚å¯ä»¥ä½¿ç”¨ AndroidView ç›´æ¥æ¸²æŸ“åŸç”Ÿçš„ UI é¡µé¢ã€‚\n\n```kotlin\n  AndroidView(\n        modifier = Modifier.fillMaxSize(),\n        factory = { context ->\n            MyView(context) }\n        },\n        update = { view ->}\n    )\n```\n\n**iOS ç«¯**  \niOSç«¯ä¸»è¦éœ€è¦ XCode è¿›è¡Œé…åˆï¼Œè¿˜éœ€è¦å…³æ³¨å¼€å‘è€…è´¦å·ç›¸å…³çš„ä¿¡æ¯ç­‰ï¼Œå…¶ä»–ä¸ Android ç«¯å®ç°æ²¡æœ‰å¤ªå¤§çš„å·®å¼‚ã€‚\n\n\n**æ¡Œé¢ç«¯**  \nåˆ©ç”¨ Compose Desktop çš„çª—å£ç®¡ç†ï¼Œå¯ä»¥å®ç°çª—å£å¤šå¼€ã€‚\n```kotlin\nfun main() = application {\n    Window(onCloseRequest = ::exitApplication) {\n        DesktopAppTheme { AppContent() }\n    }\n}\n```\n\n\n### ğŸš€ æ€§èƒ½ä¼˜åŒ–å®è·µ\n1. **åˆ†é¡µåŠ è½½**ï¼šå®ç°æ‡’åŠ è½½é˜²æ­¢é•¿åˆ—è¡¨å¡é¡¿\n```kotlin\nLazyColumn {\n    itemsIndexed(posts) { _, post ->\n        PostItem(post)\n    }\n    item { if (loading) LoadingIndicator() }\n}\n```\n\n2. **æœ¬åœ°ç¼“å­˜**ï¼šDataStore ç¦»çº¿å­˜å‚¨ + Ktor ç¼“å­˜ç­–ç•¥\n```kotlin\nHttpClient {\n    install(HttpCache) // å¯ç”¨ HTTP ç¼“å­˜\n}\n```\n\n3. **å›¾åƒå¤„ç†**ï¼šæ­é… Coil å®ç°é«˜æ•ˆå›¾ç‰‡åŠ è½½\n```kotlin\nAsyncImage(\n    modifier = Modifier.size(80.dp)\n        .shadow(\n            elevation = 5.dp,\n            shape = CircleShape,\n            spotColor = Color.Black\n        )\n        .clip(CircleShape)\n        .clickable { },\n    model = AppConfig.AVATAR,\n    contentDescription = AppConfig.AVATAR,\n)\n```\n### å¼€å‘ç»éªŒæ€»ç»“\n1. **UIç•Œé¢**\n  ä½¿ç”¨ [Compose](https://developer.android.com/compose) è¿›è¡Œç•Œé¢å¸ƒå±€å¼€å‘ï¼Œå£°æ˜æ€§ç¼–ç¨‹èŒƒå¼ç›¸æ¯”äºä¼ ç»Ÿçš„ xml å¸ƒå±€å¼€å‘ï¼Œé«˜æ•ˆå¾ˆå¤šï¼Œä½¿ç”¨ä¹Ÿå¾ˆæ–¹ä¾¿ã€‚ä½¿ç”¨äº†è¿™ç§æ–¹å¼ï¼Œä¼ ç»Ÿçš„ UI å¼€å‘æ–¹å¼å†ä¹Ÿå›ä¸å»äº†ã€‚\n\n2. **çŠ¶æ€ç®¡ç†**\nä½¿ç”¨ `mutableStateOf` å®ç°å“åº”å¼æ›´æ–°ï¼Œæˆ–è€…ä½¿ç”¨ `derivedStateOf` å®ç°æ´¾ç”ŸçŠ¶æ€çš„å¤„ç†ã€‚\n```kotlin\nvar pagIndex by remember { mutableStateOf(0) }\nvar errorState by remember { mutableStateOf<String?>(null) }   \nval themeState by mineViewModel.appTheme.collectAsState()\nval uiChecked by remember(themeState) { derivedStateOf { themeState == ThemeConstants.DARK } }\n```\n\n\n3. **å¯¼èˆª**\n\nå®ç° `Compose Navigator` ç»Ÿä¸€è·¯ç”±ç®¡ç†\n```kotlin\n  val gotoDebug: () -> Unit = {\n      navController.navigate(Routes.Debug())\n  }\n\n  val goToPostDetail: (Post) -> Unit = { it ->\n      navController.navigate(Routes.PostDetail(title = it.title, it.url))\n  }\n\n```\n\n4. **Kotlin Flow**\nç®€åŒ–å¼‚æ­¥ç¼–ç¨‹ï¼Œè®©ç½‘ç»œè¯·æ±‚çš„ä»£ç çœ‹èµ·æ¥æ›´ç›´è§‚\n```kotlin\nfun loadAllPost(): Flow<List<PostV2>> = load(\"allPosts\") {\n    postApi.getAllPost()?.data ?: emptyList()\n}\nsuspend fun getAllPost(): SearchResponse? = request<SearchResponse>(getUrl(\"api/search.json\"))\n\nprivate suspend inline fun <reified T> request(url: String): T? {\n    return try {\n        client.get(url).body()\n    } catch (e: Exception) {\n        if (e is CancellationException) throw e\n        e.printStackTrace()\n        null\n    }\n}\n```\n\n### æ€»ç»“\nç»è¿‡ä¸€ç•ªå„ç§æŠ˜è…¾ï¼Œå°†å¾ˆå¤šåœ¨å·¥ä½œä¸Šæ— æ³•ä½¿ç”¨çš„èƒ½åŠ›ï¼ˆKoinã€Flowã€DataStoreâ€¦â€¦ï¼‰éƒ½ä½“éªŒä½¿ç”¨äº†ä¸€ä¸‹ï¼Œåœ¨ä¸šä½™çš„æ—¶é—´å®Œæˆäº†åŸºäºåšå®¢æ–‡ç« æ„å»ºçš„ App åœ¨ä¸‰ä¸ªå¹³å°ä¸Šçš„å¼€å‘ï¼Œå®é™…ä¸Šæœ€åˆæˆ‘ä¹Ÿæƒ³æ­å»º WebJs çš„å¹³å°çš„ï¼Œåé¢åˆ é™¤æ‰äº†ï¼Œå› ä¸ºæ¶‰åŠåˆ° web å¹³å°å¼€å‘çš„å„ç§åº“ç›¸æ¯”å®¢æˆ·ç«¯å°‘å¾ˆå¤šï¼Œå…¼å®¹èµ·æ¥ä¹Ÿæ¯”è¾ƒè´¹åŠ²ã€‚KMP/CMP è¿™å—æŠ€æœ¯ç¡®å®æ˜¯èƒ½å¾ˆå¤§åœ°èŠ‚çœå¼€å‘äººåŠ›ï¼Œå¤šç«¯ä½¿ç”¨åŒä¸€ä»½UIé€»è¾‘ä»£ç ï¼Œéƒ¨åˆ†é€»è¾‘ä¹Ÿå¯ä»¥ç”¨ kotlin ç»Ÿä¸€è¿›è¡Œå°è£…ï¼Œåç»­ç»´æŠ¤ä¹Ÿä¼šæ–¹ä¾¿å¾ˆå¤šã€‚ä½†è¿™é‡Œæœ‰ä¸ªç¼ºç‚¹å°±æ˜¯æ¶‰åŠåˆ°çš„åº“æ‰€éœ€è¦çš„ kotlin/Java ç‰ˆæœ¬è¦æ±‚æ¯”è¾ƒé«˜ï¼Œé™¤éå¼€å‘ä¸€äº›ç‹¬ç«‹çš„ Appï¼Œå¦åˆ™å…¬å¸é‡Œçš„é¡¹ç›®æƒ³åŸºäºè¿™äº›æŠ€æœ¯å»å®ç°ä¸å¤ªå¤§å¯èƒ½ã€‚ä»¥åŠå¦‚æœæ‰€éœ€è¦çš„èƒ½åŠ›æ¯”è¾ƒä¾èµ–ä¸åŸç”Ÿï¼Œæ¯”å¦‚éŸ³è§†é¢‘é¢†åŸŸå°±æœ‰ä¸€å®šçš„å±€é™æ€§ï¼Œæ€»ä½“æ¥è®²æ›´é€‚åˆåäº¤äº’ä¸šåŠ¡çš„å¼€å‘ã€‚\n\n\n**é¡¹ç›®æºç **: https://github.com/VomPom/blog_kmp  ","categories":[{"name":"æ€è€ƒæ€»ç»“","api":"api/categories/thinking.json"}],"tags":[{"name":"KMP","api":"api/tags/KMP.json"}]},"api":"api/posts/2025/07/28/Compose-Multiplatform-è·¨å¹³å°åšå®¢åº”ç”¨å®è·µ.json"}